<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Medis - Murni Teguh Memorial Hospital</title>
    <style>
        /* --- CSS STYLE START --- */
        * { box-sizing: border-box; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        body { font-family: 'Arial', sans-serif; font-size: 13px; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 850px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        .header-container { text-align: center; margin-bottom: 5px; }
        .header-image { max-width: 100%; height: auto; display: block; margin: 0 auto; }

        /* MENU TABS */
        .menu-container { display: flex; justify-content: center; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn-tab { padding: 10px 20px; border: none; background: #ddd; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .btn-tab.active { background: #4CAF50; color: white; }

        /* DATA PASIEN */
        .patient-total-wrapper { display: flex; gap: 20px; margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; align-items: stretch; }
        .patient-info { flex: 1; }
        .info-line { display: grid; grid-template-columns: 140px 10px auto; margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 2px; }
        .info-line .label { font-weight: bold; color: #555; }
        .info-line-malnutrisi { display: none; }
        body.mode-malnutrisi .info-line-malnutrisi { display: grid; }

        /* OUTPUT BOXES */
        .output-box { width: 220px; padding: 15px; border: 2px solid #4CAF50; border-radius: 8px; text-align: center; background: #e8f5e9; display: none; flex-direction: column; justify-content: center; }
        .output-title { font-weight: bold; color: #2E7D32; margin-bottom: 5px; }
        .output-value { font-size: 24px; font-weight: bold; color: #333; }

        /* INPUT FORMS */
        .input-form { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: bold; font-size: 11px; margin-bottom: 3px; }
        .form-group input, .form-group select { padding: 6px; border: 1px solid #ccc; border-radius: 4px; width: 100%; }

        /* CHECKBOX GRID */
        .checkbox-grid { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .form-section-title { grid-column: 1 / -1; font-weight: bold; margin-top: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }

        /* TABLES */
        .scoring-table { width: 100%; border-collapse: collapse; margin-top: 15px; page-break-inside: avoid; }
        .scoring-table th, .scoring-table td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
        .scoring-table th { background-color: #f2f2f2; }
        .highlight-natrium { background-color: #e8f5e9; font-weight: bold; }

        /* MALNUTRISI FORM TABLE */
        .malnutrisi-form-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        .malnutrisi-form-table th { background: #37474f; color: white; padding: 8px; text-align: center; font-size: 12px; border: 1px solid #999; }
        .malnutrisi-form-table td { border: 1px solid #aaa; padding: 6px 8px; vertical-align: top; font-size: 12px; }
        .col-no { width: 32px; text-align: center; font-weight: bold; }
        .col-jenis { width: 210px; }
        .col-terapi { }
        .sub-label { padding-left: 18px; font-style: italic; }
        .malnutrisi-textarea { width: 100%; border: none; background: transparent; resize: vertical; min-height: 48px; font-family: Arial, sans-serif; font-size: 12px; outline: none; line-height: 1.5; }
        .malnutrisi-textarea:focus { background: #f0f7ff; border-radius: 3px; }

        /* HELPER CALCULATOR BOX */
        .helper-box { background: #e3f2fd; border: 1px solid #1976D2; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        .helper-box-title { font-weight: bold; color: #1565C0; font-size: 13px; margin-bottom: 8px; }
        .helper-results { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px; }
        .helper-result-item { background: white; border-radius: 5px; padding: 8px; text-align: center; border: 1px solid #90CAF9; }
        .helper-result-item .hval { font-size: 22px; font-weight: bold; color: #1565C0; }
        .helper-result-item .hlabel { font-size: 10px; color: #666; margin-top: 2px; }
        .enteral-helper { margin-top: 10px; background: #e8f5e9; border: 1px solid #4CAF50; border-radius: 6px; padding: 10px; }
        .enteral-helper-title { font-weight: bold; color: #2E7D32; font-size: 12px; margin-bottom: 6px; }
        .enteral-results { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .enteral-result-item { background: white; border-radius: 4px; padding: 6px; text-align: center; border: 1px solid #A5D6A7; }
        .enteral-result-item .eval { font-size: 18px; font-weight: bold; color: #2E7D32; }
        .enteral-result-item .elabel { font-size: 10px; color: #555; }
        .autofill-btn { margin-top: 8px; padding: 5px 12px; background: #1976D2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .autofill-btn:hover { background: #1565C0; }

        /* KESIMPULAN */
        .kesimpulan-box { margin-top: 15px; padding: 12px 16px; border: 2px solid #333; border-radius: 4px; }
        .kesimpulan-title { font-weight: bold; text-decoration: underline; margin-bottom: 10px; font-size: 13px; }
        .kesimpulan-catatan { font-size: 11px; margin-bottom: 10px; background: #fff8e1; border-left: 3px solid #FFC107; padding: 8px; line-height: 1.5; }
        .kesimpulan-options { display: flex; gap: 30px; align-items: center; }
        .kesimpulan-options label { display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 13px; cursor: pointer; }
        .kesimpulan-options input[type="radio"] { width: 16px; height: 16px; cursor: pointer; }

        /* FOOTER */
        .footer-section { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 20px; page-break-inside: avoid; }
        .dpjp-section { text-align: center; min-width: 200px; margin-left: auto; }
        .dpjp-input { margin-top: 5px; width: 100%; padding: 5px; text-align: center; }
        .dpjp-name { margin-top: 60px; font-weight: bold; border-bottom: 1px solid #000; padding-bottom: 5px; min-height: 20px; }
        .button-container { display: flex; gap: 10px; }
        .btn-action { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; color: white; font-weight: bold; }
        .btn-print { background: #2196F3; }
        .btn-clear { background: #f44336; }
        .dpjp-title-malnutrisi { display: none; }
        body.mode-malnutrisi .dpjp-title-default { display: none; }
        body.mode-malnutrisi .dpjp-title-malnutrisi { display: block; }

        /* PRINT RULES */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white; padding: 0; }
            .container { width: 100%; max-width: 100%; box-shadow: none; border: none; padding: 0; margin: 0; }
            .screen-only { display: none !important; }
            .patient-total-wrapper { border: 1px solid #000; }
            .footer-section { justify-content: flex-end; }
            .dpjp-section { margin-left: auto !important; }

            #calc-natrium-content, #calc-kalium-content, #calc-psi-content, #calc-malnutrisi-content,
            #natrium-output-box, #kalium-output-box, #psi-output-box, #malnutrisi-output-box { display: none !important; }

            body.mode-psi #calc-psi-content { display: block !important; }
            body.mode-psi #psi-output-box { display: flex !important; border: 2px solid #000 !important; }

            body.mode-natrium #calc-natrium-content { display: block !important; }
            body.mode-natrium #natrium-output-box { display: flex !important; border: 2px solid #000 !important; }

            body.mode-kalium #calc-kalium-content { display: block !important; }
            body.mode-kalium #kalium-output-box { display: flex !important; border: 2px solid #000 !important; }

            body.mode-malnutrisi #calc-malnutrisi-content { display: block !important; }
            body.mode-malnutrisi #malnutrisi-output-box { display: flex !important; border: 2px solid #000 !important; }
            body.mode-malnutrisi .helper-box { display: none !important; }
            body.mode-malnutrisi .autofill-btn { display: none !important; }
            body.mode-malnutrisi .info-line-malnutrisi { display: grid !important; }
            .malnutrisi-textarea { min-height: 40px; }
            .malnutrisi-form-table td, .malnutrisi-form-table th { border: 1px solid #000; }
        }
        /* MODAL SKRINING */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.55); z-index: 2000; display: none; overflow-y: auto; padding: 20px 0; }
        .modal-box { max-width: 760px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 6px 30px rgba(0,0,0,0.35); overflow: hidden; }
        .modal-header { background: #37474f; color: white; padding: 14px 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 14px; }
        .modal-close { background: none; border: none; color: white; font-size: 22px; cursor: pointer; line-height: 1; padding: 0; }
        .modal-tabs { display: flex; border-bottom: 2px solid #ddd; background: #f8f8f8; }
        .modal-tab { padding: 10px 18px; border: none; background: none; cursor: pointer; font-weight: bold; font-size: 12px; color: #777; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .modal-tab.active { color: #37474f; border-bottom-color: #37474f; background: white; }
        .modal-body { padding: 16px; max-height: 58vh; overflow-y: auto; }
        .aspen-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .aspen-table th { background: #455a64; color: white; padding: 8px 10px; text-align: center; font-size: 11px; }
        .aspen-table td { border: 1px solid #ddd; padding: 7px 10px; vertical-align: top; }
        .aspen-table tr:nth-child(even) td { background: #fafafa; }
        .aspen-crit { font-weight: bold; font-size: 12px; }
        .aspen-desc { font-size: 10px; color: #555; margin-top: 2px; line-height: 1.4; }
        .aspen-radio-group { display: flex; flex-direction: column; gap: 5px; }
        .aspen-radio-group label { display: flex; align-items: flex-start; gap: 6px; font-size: 11px; cursor: pointer; line-height: 1.4; }
        .aspen-radio-group label.opt-sedang { color: #e65100; }
        .aspen-radio-group label.opt-berat { color: #b71c1c; font-weight: bold; }
        .aspen-count-bar { display: flex; gap: 15px; padding: 10px 14px; background: #eceff1; border-radius: 6px; margin-top: 12px; font-size: 12px; align-items: center; }
        .count-badge { padding: 4px 14px; border-radius: 12px; font-size: 13px; font-weight: bold; }
        .count-badge.sedang { background: #fff3e0; color: #e65100; border: 1px solid #FFB74D; }
        .count-badge.berat { background: #ffebee; color: #b71c1c; border: 1px solid #EF9A9A; }
        .etiologi-btns { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
        .etiologi-btn { padding: 7px 16px; border: 2px solid #ccc; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold; background: white; }
        .etiologi-btn.selected { border-color: #37474f; background: #37474f; color: white; }
        .tabel7-grid { border: 1px solid #bbb; border-radius: 6px; overflow: hidden; font-size: 11px; }
        .t7-row { display: grid; grid-template-columns: 155px 1fr 1fr; border-bottom: 1px solid #ddd; }
        .t7-row:last-child { border-bottom: none; }
        .t7-cell { padding: 7px 10px; border-right: 1px solid #ddd; line-height: 1.5; }
        .t7-cell:last-child { border-right: none; }
        .t7-header { background: #455a64; color: white; font-weight: bold; text-align: center; font-size: 12px; }
        .t7-sedang { background: #fff8e1; }
        .t7-berat { background: #fce4ec; }
        .t7-label { font-weight: bold; background: #eceff1; font-size: 11px; }
        .antropo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .antropo-card { border: 1px solid #ddd; border-radius: 6px; padding: 12px; }
        .antropo-card h4 { margin: 0 0 10px 0; color: #37474f; font-size: 13px; border-bottom: 1px solid #eee; padding-bottom: 6px; }
        .klasif-row { display: flex; justify-content: space-between; font-size: 11px; padding: 4px 0; border-bottom: 1px dashed #eee; }
        .klasif-row.match { background: #e8f5e9; font-weight: bold; border-radius: 3px; padding: 4px 6px; }
        .modal-footer { background: #f5f5f5; border-top: 2px solid #ddd; padding: 12px 16px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .result-pill { padding: 6px 18px; border-radius: 20px; font-weight: bold; font-size: 14px; background: #eee; border: 2px solid #ccc; min-width: 200px; text-align: center; }
        .result-pill.sedang { background: #fff3e0; color: #e65100; border-color: #FFB74D; }
        .result-pill.berat { background: #ffebee; color: #b71c1c; border-color: #EF9A9A; }
        .btn-apply-skrining { padding: 8px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px; }
        @media print { .modal-overlay { display: none !important; } }
        /* NRS-2002 */
        .nrs-section { margin-bottom: 14px; }
        .nrs-section-title { font-weight: bold; color: #37474f; font-size: 12px; background: #eceff1; padding: 6px 10px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid #607d8b; }
        .nrs-option { display: flex; align-items: flex-start; gap: 8px; font-size: 12px; padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-bottom: 3px; border: 1px solid transparent; line-height: 1.5; }
        .nrs-option:hover { background: #f5f5f5; border-color: #e0e0e0; }
        .nrs-option input[type="radio"] { margin-top: 3px; flex-shrink: 0; }
        .nrs-prescreen label { display: flex; gap: 8px; font-size: 12px; padding: 6px 10px; cursor: pointer; align-items: flex-start; border-radius: 4px; margin-bottom: 3px; line-height: 1.5; }
        .nrs-prescreen label:hover { background: #f5f5f5; }
        .nrs-prescreen input[type="checkbox"] { margin-top: 3px; flex-shrink: 0; }
        .nrs-score-box { display: flex; gap: 10px; padding: 12px 16px; background: #eceff1; border-radius: 6px; margin-top: 12px; align-items: center; flex-wrap: wrap; justify-content: center; }
        .nrs-score-item { text-align: center; min-width: 48px; }
        .nrs-score-num { font-size: 28px; font-weight: bold; color: #37474f; line-height: 1; }
        .nrs-score-label { font-size: 10px; color: #777; margin-top: 3px; }
        .nrs-result-box { padding: 10px 14px; border-radius: 6px; font-weight: bold; font-size: 13px; margin-top: 10px; text-align: center; }
        .nrs-result-box.risk { background: #ffebee; color: #b71c1c; border: 1px solid #EF9A9A; }
        .nrs-result-box.no-risk { background: #e8f5e9; color: #2E7D32; border: 1px solid #A5D6A7; }
        /* --- CSS END --- */
    </style>
</head>
<body class="mode-psi">
    <div class="container">
        <div class="header-container">
            <img src="header.jpg" alt="Header" class="header-image">
        </div>

        <!-- TAB MENU -->
        <div class="menu-container screen-only">
            <button onclick="showCalculator('psi')" id="btn-psi" class="btn-tab active">PSI Score</button>
            <button onclick="showCalculator('natrium')" id="btn-natrium" class="btn-tab">Koreksi Natrium</button>
            <button onclick="showCalculator('kalium')" id="btn-kalium" class="btn-tab">Koreksi Kalium</button>
            <button onclick="showCalculator('malnutrisi')" id="btn-malnutrisi" class="btn-tab" style="background:#795548; color:white;">Tatalaksana Malnutrisi</button>
        </div>

        <!-- PATIENT INFO HEADER -->
        <div class="patient-total-wrapper">
            <div class="patient-info">
                <div class="info-line"><span class="label">Nama</span><span>:</span><span id="displayNama">-</span></div>
                <div class="info-line"><span class="label">No. MR</span><span>:</span><span id="displayNoMR">-</span></div>
                <div class="info-line"><span class="label">Tgl Lahir</span><span>:</span><span id="displayTglLahir">-</span></div>
                <div class="info-line"><span class="label">Umur</span><span>:</span><span id="displayUmur">-</span></div>
                <div class="info-line"><span class="label">Tgl Assessment</span><span>:</span><span id="displayTglAsesmen">-</span></div>
                <!-- Hanya tampil di mode malnutrisi -->
                <div class="info-line info-line-malnutrisi"><span class="label">Ruang</span><span>:</span><span id="displayRuang">-</span></div>
                <div class="info-line info-line-malnutrisi"><span class="label">Jam</span><span>:</span><span id="displayJam">-</span></div>
            </div>

            <div id="psi-output-box" class="output-box">
                <div class="output-title">PSI Score</div>
                <div class="output-value" id="totalScore">0</div>
                <div class="output-label">Kelas: <span id="kelasRisiko">-</span></div>
                <div class="output-label" style="font-size: 11px;">Mortality: <span id="mortalityRate">-</span></div>
            </div>

            <div id="natrium-output-box" class="output-box">
                <div class="output-title">Delta Na+</div>
                <div class="output-value"><span id="displayDeltaTotal">0</span> <small>mEq</small></div>
                <div class="output-label"><span id="displayNaAwal">0</span> &rarr; <span id="displayNaTarget">0</span></div>
            </div>

            <div id="kalium-output-box" class="output-box">
                <div class="output-title">Kebutuhan KCl</div>
                <div class="output-value"><span id="displayKebutuhanK">0</span> <small>mEq</small></div>
                <div class="output-label"><span id="displayKaliumSerum">0</span> &rarr; <span id="displayKTarget">0</span></div>
                <div class="output-label" style="font-size: 11px;">Delta: <span id="displayDeltaK">0</span></div>
            </div>

            <div id="malnutrisi-output-box" class="output-box" style="background:#fff3e0; border-color:#FF8F00;">
                <div class="output-title" style="color:#E65100;">Diagnosis</div>
                <div class="output-value" id="displayDiagnosis" style="font-size: 16px; color:#BF360C;">-</div>
                <div style="margin-top:8px; font-size:11px; color:#555;">Target Kalori</div>
                <div style="font-weight:bold; color:#333;" id="displayTargetKkal">- kkal/hari</div>
                <div style="font-size:11px; color:#555; margin-top:4px;">Target Protein</div>
                <div style="font-weight:bold; color:#333;" id="displayTargetProtein">- g/hari</div>
            </div>
        </div>

        <!-- SHARED INPUT FORM -->
        <div class="input-form screen-only">
            <div class="form-group"><label>Nama Pasien*:</label><input type="text" id="nama"></div>
            <div class="form-group"><label>No. MR (10 Digit)*:</label><input type="text" id="noMR" maxlength="10"></div>
            <div class="form-group"><label>Tgl Lahir*:</label><input type="date" id="tglLahir"></div>
            <div class="form-group"><label>Jenis Kelamin*:</label><select id="jk"><option value="L">Laki-laki</option><option value="P">Perempuan</option></select></div>
            <div class="form-group"><label>Tgl Assessment*:</label><input type="date" id="tglAsesmen"></div>
            <div class="form-group"><label>Berat Badan (kg)*:</label><input type="number" id="bb"></div>

            <!-- PSI INPUT GROUP -->
            <div id="input-psi-group" style="display:contents;">
                <div class="form-section-title">Riwayat &amp; Komorbiditas</div>
                <div class="checkbox-grid">
                    <label><input type="checkbox" class="psi-check" data-score="30" data-id="cancer"> Keganasan (+30)</label>
                    <label><input type="checkbox" class="psi-check" data-score="20" data-id="liver"> Penyakit Hati (+20)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="hf"> Penyakit Jantung Kongestif (+10)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="cvd"> Penyakit Serebrovaskular (+10)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="renal"> Penyakit Ginjal (+10)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="nursing"> Penghuni panti werda (+10)</label>
                </div>
                <div class="form-section-title">Pemeriksaan Fisik</div>
                <div class="checkbox-grid">
                    <label><input type="checkbox" class="psi-check" data-score="20" data-id="ams"> Gangguan Kesadaran (+20)</label>
                    <label><input type="checkbox" class="psi-check" data-score="20" data-id="rr"> Respiratory Rate &gt;30 x/menit (+20)</label>
                    <label><input type="checkbox" class="psi-check" data-score="20" data-id="sys"> Systolic BP &lt;90 mmHg (+20)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="temp"> Temperature &lt;35¬∞C / &gt;40¬∞C (+10)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="pulse"> Heart Rate &gt; 125 x/menit (+10)</label>
                </div>
                <div class="form-section-title">Laboratorium &amp; Radiologi</div>
                <div class="checkbox-grid">
                    <label><input type="checkbox" class="psi-check" data-score="30" data-id="ph"> pH &lt;7.35 (+30)</label>
                    <label><input type="checkbox" class="psi-check" data-score="20" data-id="bun"> Ureum &gt;64.2 mg/dL (+20)</label>
                    <label><input type="checkbox" class="psi-check" data-score="20" data-id="na"> Natrium &lt;130 mEq/L (+20)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="glu"> Glukosa &gt;250 mg/dL (+10)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="hct"> Hematokrit &lt;30% (+10)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="po2"> PO‚ÇÇ darah Arteri &lt;60 mmHg (+10)</label>
                    <label><input type="checkbox" class="psi-check" data-score="10" data-id="pleural"> Efusi Pleura (+10)</label>
                </div>
            </div>

            <!-- NATRIUM INPUT GROUP -->
            <div id="input-natrium-group" style="display:none; display:contents;">
                <div class="form-group"><label>Na Serum Awal:</label><input type="number" id="naSerum"></div>
                <div class="form-group"><label>Target Na:</label><input type="number" id="naTarget" value="135"></div>
                <div class="form-group"><label>Cairan Infus:</label>
                    <select id="naInfus"><option value="513">NaCl 3%</option><option value="154">NaCl 0.9%</option></select>
                </div>
                <div class="form-group"><label>Max Koreksi (mEq/24h):</label><input type="number" id="naKecepatan" value="8"></div>
            </div>

            <!-- KALIUM INPUT GROUP -->
            <div id="input-kalium-group" style="display:none; display:contents;">
                <div class="form-group"><label>K Serum Awal:</label><input type="number" id="kSerum" step="0.1"></div>
                <div class="form-group"><label>Target K (mEq/L):</label><input type="number" id="kTarget" step="0.1" value="3.5"></div>
                <div class="form-group"><label>Akses Vena:</label>
                    <select id="aksesVena">
                        <option value="perifer">Vena Perifer</option>
                        <option value="sentral">Vena Sentral</option>
                    </select>
                </div>
                <div class="form-group"><label>Kecepatan Koreksi:</label>
                    <div style="display:flex; align-items:center; gap:4px;">
                        <button onclick="changeKacepatanK(-1)" style="padding:4px 11px; border:1px solid #bbb; border-radius:4px; background:#f5f5f5; cursor:pointer; font-size:18px; line-height:1; flex-shrink:0;">‚àí</button>
                        <select id="kecepatanK" style="flex:1; text-align:center;">
                            <option value="5" selected>5 mEq/jam</option>
                            <option value="6">6 mEq/jam</option>
                            <option value="7">7 mEq/jam</option>
                            <option value="8">8 mEq/jam</option>
                            <option value="9">9 mEq/jam</option>
                            <option value="10">10 mEq/jam</option>
                            <option value="15">15 mEq/jam (Sentral)</option>
                            <option value="20">20 mEq/jam (Sentral)</option>
                            <option value="25">25 mEq/jam (Sentral, Life-threatening)</option>
                            <option value="30">30 mEq/jam (Sentral, Life-threatening)</option>
                            <option value="35">35 mEq/jam (Sentral, Life-threatening)</option>
                            <option value="40">40 mEq/jam (Sentral, Life-threatening)</option>
                        </select>
                        <button onclick="changeKacepatanK(1)" style="padding:4px 11px; border:1px solid #bbb; border-radius:4px; background:#f5f5f5; cursor:pointer; font-size:18px; line-height:1; flex-shrink:0;">+</button>
                    </div>
                </div>
            </div>

            <!-- MALNUTRISI INPUT GROUP -->
            <div id="input-malnutrisi-group" style="display:none; display:contents;">
                <div class="form-section-title">Data Tambahan &amp; Parameter Kalkulasi</div>
                <div class="form-group"><label>Ruang/Ward:</label><input type="text" id="ruang" placeholder="cth: ICU, 6 South"></div>
                <div class="form-group"><label>Jam Assessment:</label><input type="time" id="jam"></div>
                <div class="form-group"><label>Tinggi Badan (cm):</label><input type="number" id="tb" placeholder="Opsional (BMI)"></div>
                <div class="form-group"><label>Kondisi / Faktor Stres:</label>
                    <select id="faktorStres">
                        <option value="25">Normal (25 kkal/kg)</option>
                        <option value="27">Stres Ringan (27 kkal/kg)</option>
                        <option value="30" selected>Stres Sedang (30 kkal/kg)</option>
                        <option value="35">Stres Berat (35 kkal/kg)</option>
                    </select>
                </div>
                <div class="form-group"><label>Faktor Protein (g/kg):</label>
                    <select id="faktorProtein">
                        <option value="0.8">0.8 g/kg (Normal)</option>
                        <option value="1.0">1.0 g/kg (Ringan)</option>
                        <option value="1.2" selected>1.2 g/kg (Sedang)</option>
                        <option value="1.5">1.5 g/kg (Berat)</option>
                        <option value="2.0">2.0 g/kg (Kritis/Hiperkatabolik)</option>
                    </select>
                </div>
                <div class="form-group"><label>% Lemak dari Total Kalori:</label>
                    <select id="persenLemak">
                        <option value="20">20%</option>
                        <option value="25" selected>25%</option>
                        <option value="30">30%</option>
                        <option value="35">35%</option>
                    </select>
                </div>
                <div class="form-section-title">Parameter Nutrisi Enteral</div>
                <div class="form-group"><label>Densitas Formula:</label>
                    <select id="densitasFormula">
                        <option value="1.0">Standard 1.0 kkal/mL</option>
                        <option value="1.5">High-Cal 1.5 kkal/mL</option>
                        <option value="2.0">High-Cal 2.0 kkal/mL</option>
                    </select>
                </div>
                <div class="form-group"><label>Frekuensi Pemberian:</label>
                    <select id="frekEnteral">
                        <option value="3">3√ó sehari</option>
                        <option value="4" selected>4√ó sehari</option>
                        <option value="5">5√ó sehari</option>
                        <option value="6">6√ó sehari</option>
                        <option value="0">Kontinyu 24 jam</option>
                    </select>
                </div>
                <div class="form-group"><label>% Kalori Enteral dari Target:</label>
                    <select id="pctEnteral">
                        <option value="100" selected>100%</option>
                        <option value="75">75%</option>
                        <option value="50">50%</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- CONTENT SECTIONS -->
        <div id="calc-psi-content" class="calc-content"></div>
        <div id="calc-natrium-content" class="calc-content" style="display:none;"><div id="natrium-tables-container"></div></div>
        <div id="calc-kalium-content" class="calc-content" style="display:none;">
            <div id="kalium-result-table"><table class="scoring-table"><thead><tr><th>Rencana Tata Laksana</th><th>Instruksi Klinis</th></tr></thead><tbody id="kalium-instructions"></tbody></table></div>
        </div>

        <!-- MALNUTRISI CONTENT -->
        <div id="calc-malnutrisi-content" class="calc-content" style="display:none;">

            <!-- Helper: Target Kalori & Protein (screen only) -->
            <div class="helper-box screen-only">
                <div class="helper-box-title">üßÆ Kalkulator Target Nutrisi</div>
                <div class="helper-results">
                    <div class="helper-result-item">
                        <div class="hval" id="hTargetKkal">-</div>
                        <div class="hlabel">Target Kalori (kkal/hari)</div>
                    </div>
                    <div class="helper-result-item">
                        <div class="hval" id="hTargetProtein">-</div>
                        <div class="hlabel">Target Protein (g/hari)</div>
                    </div>
                    <div class="helper-result-item">
                        <div class="hval" id="hTargetLemak">-</div>
                        <div class="hlabel">Target Lemak (g/hari)</div>
                    </div>
                    <div class="helper-result-item">
                        <div class="hval" id="hTargetKarbo">-</div>
                        <div class="hlabel">Target KH (g/hari)</div>
                    </div>
                    <div class="helper-result-item">
                        <div class="hval" id="hBMI">-</div>
                        <div class="hlabel">BMI (kg/m¬≤)</div>
                    </div>
                    <div class="helper-result-item">
                        <div class="hval" id="hFaktorKalori">-</div>
                        <div class="hlabel">Faktor Kalori (kkal/kg)</div>
                    </div>
                </div>

                <!-- Enteral Helper -->
                <div class="enteral-helper" id="enteral-helper-section">
                    <div class="enteral-helper-title">üçº Rencana Nutrisi Enteral</div>
                    <div class="enteral-results">
                        <div class="enteral-result-item">
                            <div class="eval" id="eVolTotal">-</div>
                            <div class="elabel">Volume Total (mL/hari)</div>
                        </div>
                        <div class="enteral-result-item">
                            <div class="eval" id="eVolPerPemberian">-</div>
                            <div class="elabel">Volume/Pemberian (mL)</div>
                        </div>
                        <div class="enteral-result-item">
                            <div class="eval" id="eKecepatan">-</div>
                            <div class="elabel">Kecepatan Infus (mL/jam)</div>
                        </div>
                    </div>
                    <button class="autofill-btn" onclick="autofillEnteral()">‚¨á Auto-isi Kolom Terapi Enteral</button>
                </div>
            </div>

            <!-- FORM TATALAKSANA MALNUTRISI -->
            <div style="text-align:center; font-weight:bold; font-size:14px; padding: 8px; background:#37474f; color:white; border-radius:4px 4px 0 0; margin-top:5px;">
                FORM TATALAKSANA MALNUTRISI
            </div>
            <table class="malnutrisi-form-table">
                <thead>
                    <tr>
                        <th class="col-no">No.</th>
                        <th class="col-jenis">Jenis</th>
                        <th class="col-terapi">Tindakan / Terapi</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 1. Skrining gizi -->
                    <tr>
                        <td class="col-no">1.</td>
                        <td class="col-jenis">Skrining gizi</td>
                        <td>
                            <div class="screen-only" style="margin-bottom:6px;">
                                <button onclick="openSkriningModal()" style="padding:5px 12px; background:#37474f; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px; font-weight:bold;">üìã Klasifikasi Malnutrisi</button>
                            </div>
                            <div class="screen-only" style="margin-bottom:4px;">
                                <select id="hasilSkrining" onchange="updateStats()" style="padding:3px 6px; border:1px solid #ccc; border-radius:3px; font-size:12px; margin-right:5px;">
                                    <option value="">-- Pilih Hasil Skrining --</option>
                                    <optgroup label="SGA (Subjective Global Assessment)">
                                        <option value="SGA A (Gizi Baik)">SGA A ‚Äî Gizi Baik</option>
                                        <option value="SGA B (Malnutrisi Ringan-Sedang)">SGA B ‚Äî Malnutrisi Ringan-Sedang</option>
                                        <option value="SGA C (Malnutrisi Berat)">SGA C ‚Äî Malnutrisi Berat</option>
                                    </optgroup>
                                    <optgroup label="NRS-2002">
                                        <option value="NRS-2002 skor &lt;3 (Tidak Berisiko)">NRS-2002 &lt;3 ‚Äî Tidak Berisiko</option>
                                        <option value="NRS-2002 skor ‚â•3 (Berisiko Malnutrisi)">NRS-2002 ‚â•3 ‚Äî Berisiko Malnutrisi</option>
                                    </optgroup>
                                    <optgroup label="MNA (Lansia)">
                                        <option value="MNA Normal (‚â•24 poin)">MNA Normal ‚â•24 poin</option>
                                        <option value="MNA Risiko Malnutrisi (17-23.5 poin)">MNA Risiko (17‚Äì23.5 poin)</option>
                                        <option value="MNA Malnutrisi (&lt;17 poin)">MNA Malnutrisi &lt;17 poin</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div id="printSkrining" style="font-size:12px; min-height:16px;"></div>
                            <textarea class="malnutrisi-textarea screen-only" id="skriningDetail" placeholder="Catatan tambahan skrining gizi..."></textarea>
                        </td>
                    </tr>

                    <!-- 2. Asessmen medik gizi -->
                    <tr>
                        <td class="col-no">2.</td>
                        <td class="col-jenis">Asessmen medik gizi</td>
                        <td>
                            <textarea class="malnutrisi-textarea" id="asessmen" placeholder="cth: BB turun, kehilangan lemak subkutan, edema (+), albumin 1.4 g/dL..."></textarea>
                        </td>
                    </tr>

                    <!-- 3. Terapi medik gizi -->
                    <tr>
                        <td class="col-no">3.</td>
                        <td class="col-jenis">Terapi medik gizi</td>
                        <td>
                            <div id="printTargetRingkas" style="font-size:12px; min-height:16px; margin-bottom:4px; font-style:italic;"></div>
                            <textarea class="malnutrisi-textarea" id="terapiMedikGizi" placeholder="Ringkasan target & terapi, cth: Target 1800 kkal, 90g protein, 50g lemak. Vit B kap 3√ó1tab, Zinc 2√ó20mg, Vit C 3√ó100mg."></textarea>
                        </td>
                    </tr>

                    <!-- 3a. Terapi nutrisi oral -->
                    <tr style="background:#fafafa;">
                        <td class="col-no" style="font-size:11px; color:#666;">3a.</td>
                        <td class="col-jenis sub-label">Terapi nutrisi oral</td>
                        <td>
                            <textarea class="malnutrisi-textarea" id="terapiOral" placeholder="cth: Diet TKTP 1800 kkal, suplemen oral 2√ó1 sach..."></textarea>
                        </td>
                    </tr>

                    <!-- 3b. Terapi nutrisi enteral -->
                    <tr style="background:#fafafa;">
                        <td class="col-no" style="font-size:11px; color:#666;">3b.</td>
                        <td class="col-jenis sub-label">Terapi nutrisi enteral</td>
                        <td>
                            <textarea class="malnutrisi-textarea" id="terapiEnteral" placeholder="Klik 'Auto-isi' di atas atau tulis manual, cth: mulai 1300 kkal via NGT, sonde 4√ó200 mL enteral..."></textarea>
                        </td>
                    </tr>

                    <!-- 3c. Terapi nutrisi parenteral -->
                    <tr style="background:#fafafa;">
                        <td class="col-no" style="font-size:11px; color:#666;">3c.</td>
                        <td class="col-jenis sub-label">Terapi nutrisi parenteral</td>
                        <td>
                            <textarea class="malnutrisi-textarea" id="terapiParenteral" placeholder="cth: Aminofluid 500 mL/24 jam, Clinimix 1000 mL/24 jam..."></textarea>
                        </td>
                    </tr>

                    <!-- 4. Edukasi gizi -->
                    <tr>
                        <td class="col-no">4.</td>
                        <td class="col-jenis">Edukasi gizi</td>
                        <td>
                            <textarea class="malnutrisi-textarea" id="edukasiGizi" placeholder="cth: Diet enteral biasanya sesuai kondisi, edukasi keluarga tentang pentingnya asupan adekuat..."></textarea>
                        </td>
                    </tr>

                    <!-- 5. Monev gizi -->
                    <tr>
                        <td class="col-no">5.</td>
                        <td class="col-jenis">Monev gizi</td>
                        <td>
                            <div class="screen-only" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:6px; font-size:12px;">
                                <label><input type="checkbox" class="monev-check" value="Terapi enteral/parenteral"> Terapi enteral/parenteral</label>
                                <label><input type="checkbox" class="monev-check" value="Asupan harian"> Asupan harian</label>
                                <label><input type="checkbox" class="monev-check" value="Albumin"> Albumin</label>
                                <label><input type="checkbox" class="monev-check" value="Berat badan"> Berat badan</label>
                                <label><input type="checkbox" class="monev-check" value="Kalau puasa"> Kalau puasa</label>
                                <label><input type="checkbox" class="monev-check" value="Lab lanjutan (prealbumin, transferin)"> Lab lanjutan</label>
                            </div>
                            <div id="printMonev" style="font-size:12px; min-height:16px;"></div>
                            <textarea class="malnutrisi-textarea screen-only" id="monevDetail" placeholder="Catatan tambahan monitoring & evaluasi..."></textarea>
                        </td>
                    </tr>

                    <!-- 6. Rujuk balik -->
                    <tr>
                        <td class="col-no">6.</td>
                        <td class="col-jenis">Rujuk balik kontrol ke poli gizi klinik</td>
                        <td>
                            <textarea class="malnutrisi-textarea" id="rujukBalik" placeholder="cth: Rujuk kontrol poli gizi 2 minggu pasca pulang..."></textarea>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- KESIMPULAN -->
            <div class="kesimpulan-box">
                <div class="kesimpulan-catatan">
                    <strong>CATATAN:</strong> Diagnosis Malnutrisi ditegakkan apabila memenuhi minimal 2 dari 6 kriteria di atas
                    ATAU memenuhi kriteria Tambahan seperti Kriteria Antropometri ATAU pemeriksaan laboratorium.
                </div>
                <div class="kesimpulan-title">KESIMPULAN:</div>
                <div class="kesimpulan-options">
                    <div id="displayKesimpulan" style="font-size:15px; font-weight:bold; color:#999; padding:4px 0; letter-spacing:0.5px;">‚Äî</div>
                    <div style="font-size:10px; color:#aaa; margin-top:2px;">(mengikuti hasil skrining gizi)</div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer-section">
            <div class="button-container screen-only">
                <button onclick="printAndDownload()" class="btn-action btn-print">Print / Save PDF</button>
                <button onclick="location.reload()" class="btn-action btn-clear">Clear</button>
            </div>
            <div class="dpjp-section">
                <p>Medan, <span id="displayTanggalPrint"></span></p>
                <p class="dpjp-title-default">Diketahui oleh,</p>
                <p class="dpjp-title-malnutrisi">Dokter Spesialis Gizi Klinis,</p>
                <input type="text" id="inputDPJP" placeholder="Nama Dokter*" class="screen-only dpjp-input">
                <div id="displayDPJP" class="dpjp-name"></div>
            </div>
        </div>
    </div>

    <!-- MODAL SKRINING GIZI (Tabel 7 PnPK Gizi) -->
    <div id="modal-skrining" class="modal-overlay" onclick="if(event.target===this)closeSkriningModal()">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Klasifikasi Malnutrisi</h3>
                <button class="modal-close" onclick="closeSkriningModal()">√ó</button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" id="mtab-aspen" onclick="showModalTab('aspen')">6 Kriteria ASPEN</button>
                <button class="modal-tab" id="mtab-tabel7" onclick="showModalTab('tabel7')">Etiologi</button>
                <button class="modal-tab" id="mtab-antropo" onclick="showModalTab('antropo')">Antropometri</button>
                <button class="modal-tab" id="mtab-nrs" onclick="showModalTab('nrs')">NRS-2002</button>
            </div>

            <!-- Tab 1: ASPEN 6 Criteria -->
            <div id="modal-body-aspen" class="modal-body">
                <p style="font-size:11px; color:#555; margin:0 0 10px 0;">Diagnosis malnutrisi ditegakkan bila <strong>‚â•2 kriteria</strong> terpenuhi (Academy of Nutrition/ASPEN, 2012).</p>
                <table class="aspen-table">
                    <thead>
                        <tr>
                            <th style="width:40%">Kriteria Klinis</th>
                            <th>Pilihan</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><div class="aspen-crit">1. Asupan energi tidak adekuat</div><div class="aspen-desc">Asupan kalori &lt; kebutuhan dalam periode tertentu</div></td>
                            <td><div class="aspen-radio-group">
                                <label><input type="radio" name="aspen1" value="0" checked> Tidak Ada</label>
                                <label class="opt-sedang"><input type="radio" name="aspen1" value="sedang" onchange="calcAspen()"> Sedang ‚Äî &lt;75% &gt;7 hari (akut) / ‚â•1 bulan (kronik)</label>
                                <label class="opt-berat"><input type="radio" name="aspen1" value="berat" onchange="calcAspen()"> Berat ‚Äî ‚â§50% ‚â•5 hari (akut) / &lt;75% ‚â•1 bulan (kronik)</label>
                            </div></td>
                        </tr>
                        <tr>
                            <td><div class="aspen-crit">2. Penurunan berat badan</div><div class="aspen-desc">Kehilangan BB signifikan dalam waktu tertentu</div></td>
                            <td><div class="aspen-radio-group">
                                <label><input type="radio" name="aspen2" value="0" checked> Tidak Ada</label>
                                <label class="opt-sedang"><input type="radio" name="aspen2" value="sedang" onchange="calcAspen()"> Sedang ‚Äî 1‚Äì2%/1 mg, 5%/1 bl, 7.5%/3 bl</label>
                                <label class="opt-berat"><input type="radio" name="aspen2" value="berat" onchange="calcAspen()"> Berat ‚Äî &gt;2%/1 mg, &gt;5%/1 bl, &gt;7.5%/3 bl</label>
                            </div></td>
                        </tr>
                        <tr>
                            <td><div class="aspen-crit">3. Penurunan massa otot</div><div class="aspen-desc">Dinilai klinis: temporal, deltoid, thenar, kuadriseps</div></td>
                            <td><div class="aspen-radio-group">
                                <label><input type="radio" name="aspen3" value="0" checked> Tidak Ada</label>
                                <label class="opt-sedang"><input type="radio" name="aspen3" value="sedang" onchange="calcAspen()"> Sedang ‚Äî penurunan ringan</label>
                                <label class="opt-berat"><input type="radio" name="aspen3" value="berat" onchange="calcAspen()"> Berat ‚Äî penurunan sedang‚Äìberat</label>
                            </div></td>
                        </tr>
                        <tr>
                            <td><div class="aspen-crit">4. Penurunan lemak subkutan</div><div class="aspen-desc">Kulit atas trisep, pinggang, abdomen</div></td>
                            <td><div class="aspen-radio-group">
                                <label><input type="radio" name="aspen4" value="0" checked> Tidak Ada</label>
                                <label class="opt-sedang"><input type="radio" name="aspen4" value="sedang" onchange="calcAspen()"> Sedang ‚Äî penurunan ringan</label>
                                <label class="opt-berat"><input type="radio" name="aspen4" value="berat" onchange="calcAspen()"> Berat ‚Äî penurunan sedang‚Äìberat</label>
                            </div></td>
                        </tr>
                        <tr>
                            <td><div class="aspen-crit">5. Akumulasi cairan (edema)</div><div class="aspen-desc">Edema lokalisata atau generalisata terkait malnutrisi</div></td>
                            <td><div class="aspen-radio-group">
                                <label><input type="radio" name="aspen5" value="0" checked> Tidak Ada</label>
                                <label class="opt-sedang"><input type="radio" name="aspen5" value="sedang" onchange="calcAspen()"> Sedang ‚Äî edema ringan‚Äìsedang</label>
                                <label class="opt-berat"><input type="radio" name="aspen5" value="berat" onchange="calcAspen()"> Berat ‚Äî edema sedang‚Äìberat / anasarka</label>
                            </div></td>
                        </tr>
                        <tr>
                            <td><div class="aspen-crit">6. Penurunan status fungsional</div><div class="aspen-desc">Hand grip strength &lt; normal, atau kelelahan signifikan</div></td>
                            <td><div class="aspen-radio-group">
                                <label><input type="radio" name="aspen6" value="0" checked> Tidak Ada</label>
                                <label class="opt-sedang"><input type="radio" name="aspen6" value="sedang" onchange="calcAspen()"> Sedang ‚Äî penurunan ringan</label>
                                <label class="opt-berat"><input type="radio" name="aspen6" value="berat" onchange="calcAspen()"> Berat ‚Äî penurunan berat / imobilisasi</label>
                            </div></td>
                        </tr>
                    </tbody>
                </table>
                <div class="aspen-count-bar">
                    <span>Kriteria terpenuhi:</span>
                    <span class="count-badge sedang" id="aspen-badge-sedang">0 Sedang</span>
                    <span class="count-badge berat" id="aspen-badge-berat">0 Berat</span>
                    <span id="aspen-diagnosis-note" style="color:#888; font-size:11px;">Belum memenuhi syarat diagnosis.</span>
                </div>
            </div>

            <!-- Tab 2: Tabel 7 Etiologi -->
            <div id="modal-body-tabel7" class="modal-body" style="display:none;">
                <p style="font-size:11px; color:#555; margin:0 0 10px 0;">Pilih etiologi pasien untuk melihat kriteria <strong>Sedang</strong> vs <strong>Berat</strong> berdasarkan Tabel 7 PnPK Gizi.</p>
                <div class="etiologi-btns">
                    <button class="etiologi-btn selected" id="etbtn-akut" onclick="selectEtiologi('akut')">üè• Penyakit Akut / Cedera</button>
                    <button class="etiologi-btn" id="etbtn-kronik" onclick="selectEtiologi('kronik')">ü©∫ Penyakit Kronik</button>
                    <button class="etiologi-btn" id="etbtn-sosial" onclick="selectEtiologi('sosial')">üèò Sosial / Lingkungan</button>
                </div>
                <div class="tabel7-grid" id="tabel7-content"></div>
            </div>

            <!-- Tab 3: Antropometri -->
            <div id="modal-body-antropo" class="modal-body" style="display:none;">
                <div class="antropo-grid">
                    <div class="antropo-card">
                        <h4>Indeks Massa Tubuh (IMT / BMI)</h4>
                        <div style="font-size:12px; margin-bottom:8px;">BB: <span id="modal-bb">-</span> kg &nbsp;|&nbsp; TB: <span id="modal-tb">-</span> cm &nbsp;|&nbsp; BMI: <strong id="modal-bmi">-</strong> kg/m¬≤</div>
                        <div>
                            <div class="klasif-row" id="bmi-row-1"><span>Gizi Kurang (Wasted)</span><span>&lt; 17.0</span></div>
                            <div class="klasif-row" id="bmi-row-2"><span>Gizi Kurang (Underweight)</span><span>17.0‚Äì18.4</span></div>
                            <div class="klasif-row" id="bmi-row-3"><span>Normal</span><span>18.5‚Äì24.9</span></div>
                            <div class="klasif-row" id="bmi-row-4"><span>Overweight</span><span>25.0‚Äì29.9</span></div>
                            <div class="klasif-row" id="bmi-row-5"><span>Obese I</span><span>30.0‚Äì34.9</span></div>
                            <div class="klasif-row" id="bmi-row-6"><span>Obese II</span><span>‚â• 35.0</span></div>
                        </div>
                    </div>
                    <div class="antropo-card">
                        <h4>Lingkar Lengan Atas (LLA)</h4>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                            <label style="font-size:12px;">LLA:</label>
                            <input type="number" id="modal-lla" placeholder="cm" step="0.1" style="width:80px; padding:4px; border:1px solid #ccc; border-radius:4px; font-size:12px;" oninput="calcLLA()">
                            <span style="font-size:12px;">cm</span>
                        </div>
                        <div>
                            <div class="klasif-row" id="lla-row-1"><span>Malnutrisi Berat</span><span>&lt;19.5 cm (L) / &lt;18.5 cm (P)</span></div>
                            <div class="klasif-row" id="lla-row-2"><span>Malnutrisi Sedang</span><span>19.5‚Äì21.5 cm (L) / 18.5‚Äì20.5 cm (P)</span></div>
                            <div class="klasif-row" id="lla-row-3"><span>Normal</span><span>&gt;21.5 cm (L) / &gt;20.5 cm (P)</span></div>
                        </div>
                        <div id="lla-result" style="margin-top:8px; font-size:12px; color:#555;"></div>
                    </div>
                </div>
                <div style="margin-top:12px; background:#e8f5e9; border-radius:6px; padding:10px; font-size:11px; color:#2E7D32; border:1px solid #A5D6A7;">
                    <strong>Catatan:</strong> BMI diambil otomatis dari input BB dan TB pada form utama. LLA berguna sebagai indikator cadangan protein/lemak, terutama pada pasien yang sulit ditimbang.
                </div>
            </div>

            <!-- Tab 4: NRS-2002 -->
            <div id="modal-body-nrs" class="modal-body" style="display:none;">
                <p style="font-size:11px; color:#555; margin:0 0 12px 0;">Nutritional Risk Screening 2002 (Kondrup et al.). Skor ‚â•3 ‚Üí pasien berisiko malnutrisi ‚Üí buat rencana nutrisi.</p>

                <!-- Step 1: Pre-screen -->
                <div class="nrs-section">
                    <div class="nrs-section-title">Langkah 1 ‚Äî Skrining Awal (Jika ada 1 jawaban YA ‚Üí lanjut ke Langkah 2)</div>
                    <div class="nrs-prescreen">
                        <label><input type="checkbox" id="nrs_pre1" onchange="calcNRS()"> BMI &lt; 20.5 kg/m¬≤?</label>
                        <label><input type="checkbox" id="nrs_pre2" onchange="calcNRS()"> Penurunan <strong>berat badan</strong> dalam 3 bulan terakhir?</label>
                        <label><input type="checkbox" id="nrs_pre3" onchange="calcNRS()"> Penurunan <strong>asupan makan</strong> dalam 1 minggu terakhir?</label>
                        <label><input type="checkbox" id="nrs_pre4" onchange="calcNRS()"> Pasien dalam kondisi <strong>sakit berat</strong> / dirawat intensif?</label>
                    </div>
                    <div id="nrs-prescreen-note" style="font-size:11px; padding:6px 10px; background:#fff8e1; border-radius:4px; border-left:3px solid #FFC107; color:#555;">Jawab pertanyaan di atas terlebih dahulu.</div>
                </div>

                <!-- Step 2: Final Screening -->
                <div id="nrs-final-section" style="display:none;">
                    <div class="nrs-section">
                        <div class="nrs-section-title">Langkah 2A ‚Äî Skor Status Nutrisi (pilih salah satu)</div>
                        <label class="nrs-option"><input type="radio" name="nrs_nutr" value="0" checked onchange="calcNRS()"><span><strong>0</strong> ‚Äî Status gizi normal</span></label>
                        <label class="nrs-option"><input type="radio" name="nrs_nutr" value="1" onchange="calcNRS()"><span><strong>1 Ringan</strong> ‚Äî BB turun &gt;5% dalam 3 bulan, ATAU asupan 50‚Äì75% dari kebutuhan dalam seminggu terakhir</span></label>
                        <label class="nrs-option"><input type="radio" name="nrs_nutr" value="2" onchange="calcNRS()"><span><strong>2 Sedang</strong> ‚Äî BB turun &gt;5% dalam 2 bulan, ATAU BMI 18.5‚Äì20.5 + kondisi umum menurun, ATAU asupan 25‚Äì50% dari kebutuhan dalam seminggu terakhir</span></label>
                        <label class="nrs-option"><input type="radio" name="nrs_nutr" value="3" onchange="calcNRS()"><span><strong>3 Berat</strong> ‚Äî BB turun &gt;5% dalam 1 bulan (&gt;15% dalam 3 bulan), ATAU BMI &lt;18.5 + kondisi umum menurun, ATAU asupan 0‚Äì25% dari kebutuhan dalam seminggu terakhir</span></label>
                    </div>
                    <div class="nrs-section">
                        <div class="nrs-section-title">Langkah 2B ‚Äî Skor Beratnya Penyakit (pilih salah satu)</div>
                        <label class="nrs-option"><input type="radio" name="nrs_dis" value="0" checked onchange="calcNRS()"><span><strong>0</strong> ‚Äî Kebutuhan nutrisi normal</span></label>
                        <label class="nrs-option"><input type="radio" name="nrs_dis" value="1" onchange="calcNRS()"><span><strong>1 Ringan</strong> ‚Äî Fraktur panggul; penyakit kronik (sirosis, PPOK, hemodialisis kronik, diabetes, keganasan)</span></label>
                        <label class="nrs-option"><input type="radio" name="nrs_dis" value="2" onchange="calcNRS()"><span><strong>2 Sedang</strong> ‚Äî Operasi besar abdomen; stroke; pneumonia berat; keganasan hematologi</span></label>
                        <label class="nrs-option"><input type="radio" name="nrs_dis" value="3" onchange="calcNRS()"><span><strong>3 Berat</strong> ‚Äî Cedera kepala; transplantasi sumsum tulang; pasien ICU (APACHE &gt;10)</span></label>
                    </div>
                    <div class="nrs-section">
                        <div class="nrs-section-title">Langkah 2C ‚Äî Koreksi Usia</div>
                        <div id="nrs-age-info" style="font-size:12px; padding:7px 10px; background:#f5f5f5; border-radius:4px;">Usia &lt;70 tahun: +0 &nbsp;|&nbsp; Usia ‚â•70 tahun: tambah +1 ke total skor</div>
                    </div>
                    <div class="nrs-score-box">
                        <div class="nrs-score-item"><div class="nrs-score-num" id="nrs-s-nutr">0</div><div class="nrs-score-label">Nutrisi</div></div>
                        <div style="font-size:22px; color:#aaa; align-self:center; padding-bottom:14px;">+</div>
                        <div class="nrs-score-item"><div class="nrs-score-num" id="nrs-s-dis">0</div><div class="nrs-score-label">Penyakit</div></div>
                        <div style="font-size:22px; color:#aaa; align-self:center; padding-bottom:14px;">+</div>
                        <div class="nrs-score-item"><div class="nrs-score-num" id="nrs-s-age">0</div><div class="nrs-score-label">Usia</div></div>
                        <div style="font-size:22px; color:#aaa; align-self:center; padding-bottom:14px;">=</div>
                        <div class="nrs-score-item"><div class="nrs-score-num" id="nrs-s-total" style="font-size:38px;">0</div><div class="nrs-score-label">Total Skor</div></div>
                    </div>
                    <div id="nrs-result-box" class="nrs-result-box" style="display:none;"></div>
                </div>
            </div>

            <div class="modal-footer">
                <div style="flex:1">
                    <div style="font-size:11px; color:#888; margin-bottom:4px;">Kesimpulan Skrining:</div>
                    <div class="result-pill" id="modal-result-pill">Belum dinilai</div>
                </div>
                <button class="btn-apply-skrining" onclick="applySkriningResult()">‚úÖ Terapkan ke Form</button>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'psi';

        function showCalculator(mode) {
            currentMode = mode;
            document.body.className = 'mode-' + mode;

            document.querySelectorAll('.btn-tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');

            const allModes = ['psi', 'natrium', 'kalium', 'malnutrisi'];
            allModes.forEach(m => {
                document.getElementById(`calc-${m}-content`).style.display = 'none';
                document.getElementById(`${m}-output-box`).style.display = 'none';
            });
            document.getElementById(`calc-${mode}-content`).style.display = 'block';
            document.getElementById(`${mode}-output-box`).style.display = 'flex';

            document.getElementById('input-psi-group').style.display = (mode === 'psi') ? 'contents' : 'none';
            document.getElementById('input-natrium-group').style.display = (mode === 'natrium') ? 'contents' : 'none';
            document.getElementById('input-kalium-group').style.display = (mode === 'kalium') ? 'contents' : 'none';
            document.getElementById('input-malnutrisi-group').style.display = (mode === 'malnutrisi') ? 'contents' : 'none';

            updateStats();
        }

        function formatDateIndo(dateString) {
            if (!dateString) return "-";
            const date = new Date(dateString);
            if (isNaN(date)) return "-";
            const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const inputs = ['nama', 'noMR', 'inputDPJP', 'tglAsesmen', 'tglLahir', 'jk', 'bb',
                            'naSerum', 'naTarget', 'naKecepatan', 'naInfus',
                            'kSerum', 'kTarget', 'aksesVena', 'kecepatanK',
                            'ruang', 'jam', 'tb', 'faktorStres', 'faktorProtein', 'persenLemak',
                            'densitasFormula', 'frekEnteral', 'pctEnteral', 'hasilSkrining'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener((el.tagName === 'SELECT' || el.type === 'date' || el.type === 'time') ? 'change' : 'input', updateStats);
            });
            document.querySelectorAll('.psi-check').forEach(box => box.addEventListener('change', updateStats));
            document.querySelectorAll('.monev-check').forEach(box => box.addEventListener('change', updateStats));

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tglAsesmen').value = today;
            document.getElementById('displayTanggalPrint').textContent = formatDateIndo(today);

            // Auto-expand textareas
            document.querySelectorAll('.malnutrisi-textarea').forEach(ta => {
                ta.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = this.scrollHeight + 'px';
                });
            });

            showCalculator('psi');
        });

        function updateStats() {
            setText('displayNama', getValue('nama') || '-');
            setText('displayNoMR', getValue('noMR') || '-');
            setText('displayDPJP', getValue('inputDPJP') || '');
            setText('displayTglAsesmen', formatDateIndo(getValue('tglAsesmen')));
            setText('displayTglLahir', formatDateIndo(getValue('tglLahir')));
            setText('displayTanggalPrint', formatDateIndo(getValue('tglAsesmen')));
            setText('displayRuang', getValue('ruang') || '-');
            setText('displayJam', getValue('jam') || '-');

            const tgl = getValue('tglLahir');
            if (tgl) {
                const dob = new Date(tgl);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                if (today.getMonth() < dob.getMonth() || (today.getMonth() === dob.getMonth() && today.getDate() < dob.getDate())) age--;
                setText('displayUmur', age + " Tahun");
            }

            try { calculatePSI(); } catch(e) {}
            try { calculateNatrium(); } catch(e) {}
            try { calculateKalium(); } catch(e) {}
            try { calculateMalnutrisi(); } catch(e) {}
        }

        function calculateMalnutrisi() {
            const bb = parseFloat(getValue('bb'));
            const tb = parseFloat(getValue('tb'));
            const faktorKalori = parseFloat(getValue('faktorStres')) || 30;
            const faktorProt = parseFloat(getValue('faktorProtein')) || 1.2;
            const pctLemak = parseFloat(getValue('persenLemak')) || 25;
            const densitas = parseFloat(getValue('densitasFormula')) || 1.0;
            const frek = parseInt(getValue('frekEnteral')) || 4;
            const pctEnteral = parseFloat(getValue('pctEnteral')) || 100;

            // BMI
            let bmiText = '-';
            if (bb && tb) {
                const tbM = tb / 100;
                const bmi = bb / (tbM * tbM);
                bmiText = bmi.toFixed(1);
            }
            setText('hBMI', bmiText);
            setText('hFaktorKalori', bb ? faktorKalori : '-');

            if (!bb) {
                ['hTargetKkal','hTargetProtein','hTargetLemak','hTargetKarbo',
                 'eVolTotal','eVolPerPemberian','eKecepatan',
                 'displayTargetKkal','displayTargetProtein'].forEach(id => setText(id, '-'));
                return;
            }

            // Nutritional targets
            const targetKkal = Math.round(bb * faktorKalori);
            const targetProtein = Math.round(bb * faktorProt * 10) / 10;
            const targetLemakG = Math.round((targetKkal * (pctLemak / 100)) / 9 * 10) / 10;
            const kkalLemak = targetLemakG * 9;
            const kkalProtein = targetProtein * 4;
            const targetKarboG = Math.round(((targetKkal - kkalLemak - kkalProtein) / 4) * 10) / 10;

            setText('hTargetKkal', targetKkal);
            setText('hTargetProtein', targetProtein);
            setText('hTargetLemak', targetLemakG);
            setText('hTargetKarbo', Math.max(0, targetKarboG));
            setText('displayTargetKkal', targetKkal + ' kkal/hari');
            setText('displayTargetProtein', targetProtein + ' g/hari');

            // Auto-populate target summary for terapi field
            const ringkas = `Target: ${targetKkal} kkal/hari, Protein ${targetProtein} g/hari, Lemak ${targetLemakG} g/hari (${pctLemak}%)`;
            const printRingkasEl = document.getElementById('printTargetRingkas');
            if (printRingkasEl) printRingkasEl.textContent = ringkas;

            // Enteral calculation
            const kkalEnteral = targetKkal * (pctEnteral / 100);
            const volTotalML = Math.round(kkalEnteral / densitas);
            setText('eVolTotal', volTotalML);

            if (frek === 0) {
                // Continuous
                const rate = Math.round(volTotalML / 24);
                setText('eVolPerPemberian', '‚Äî');
                setText('eKecepatan', rate + ' mL/jam (kontinyu)');
            } else {
                const volPerPemberian = Math.round(volTotalML / frek);
                const rate = Math.round(volTotalML / 24 * 10) / 10;
                setText('eVolPerPemberian', volPerPemberian);
                setText('eKecepatan', rate);
            }

            // Skrining result ‚Üí print
            const hasilSkrining = getValue('hasilSkrining');
            const skriningDetail = document.getElementById('skriningDetail')?.value || '';
            const printSkriningEl = document.getElementById('printSkrining');
            if (printSkriningEl) {
                printSkriningEl.textContent = [hasilSkrining, skriningDetail].filter(Boolean).join(' ‚Äî ');
            }

            // Monev checkboxes ‚Üí print
            const monevChecked = Array.from(document.querySelectorAll('.monev-check:checked')).map(c => c.value);
            const monevDetail = document.getElementById('monevDetail')?.value || '';
            const printMonevEl = document.getElementById('printMonev');
            if (printMonevEl) {
                const monevItems = [...monevChecked, monevDetail].filter(Boolean);
                printMonevEl.textContent = monevItems.join(', ');
            }

            // Diagnosis / Kesimpulan ‚Äî auto-derived from hasilSkrining
            const skriningVal = getValue('hasilSkrining') || '';
            let diagnosis = '-';
            if (/Berat/.test(skriningVal) || /Malnutrisi \(<17/.test(skriningVal)) {
                diagnosis = 'MALNUTRISI BERAT';
            } else if (/Ringan-Sedang|Sedang|Risiko/.test(skriningVal)) {
                diagnosis = 'MALNUTRISI SEDANG';
            }
            const displayKes = document.getElementById('displayKesimpulan');
            if (displayKes) {
                displayKes.textContent = diagnosis === '-' ? '‚Äî' : diagnosis;
                displayKes.style.color = diagnosis === 'MALNUTRISI BERAT' ? '#b71c1c' : (diagnosis === 'MALNUTRISI SEDANG' ? '#e65100' : '#999');
            }
            setText('displayDiagnosis', diagnosis);
        }

        function autofillEnteral() {
            const bb = parseFloat(getValue('bb'));
            if (!bb) { alert('Masukkan Berat Badan terlebih dahulu.'); return; }

            const faktorKalori = parseFloat(getValue('faktorStres')) || 30;
            const faktorProt = parseFloat(getValue('faktorProtein')) || 1.2;
            const pctLemak = parseFloat(getValue('persenLemak')) || 25;
            const densitas = parseFloat(getValue('densitasFormula')) || 1.0;
            const frek = parseInt(getValue('frekEnteral')) || 4;
            const pctEnteral = parseFloat(getValue('pctEnteral')) || 100;

            const targetKkal = Math.round(bb * faktorKalori);
            const targetProtein = Math.round(bb * faktorProt * 10) / 10;
            const targetLemakG = Math.round((targetKkal * (pctLemak / 100)) / 9 * 10) / 10;
            const kkalEnteral = targetKkal * (pctEnteral / 100);
            const volTotal = Math.round(kkalEnteral / densitas);

            const densitasLabel = densitas === 1.0 ? 'Standard (1.0 kkal/mL)' : `High-Cal (${densitas} kkal/mL)`;
            let frekLabel, volPerPemberian, rateLabel;

            if (frek === 0) {
                frekLabel = 'kontinyu 24 jam';
                volPerPemberian = null;
                const rate = Math.round(volTotal / 24);
                rateLabel = `${rate} mL/jam`;
            } else {
                frekLabel = `${frek}√ó sehari`;
                volPerPemberian = Math.round(volTotal / frek);
                const rate = Math.round(volTotal / 24 * 10) / 10;
                rateLabel = `${rate} mL/jam`;
            }

            const pctLabel = pctEnteral < 100 ? ` (${pctEnteral}% dari target)` : '';
            let teks = `Nutrisi enteral${pctLabel}: target ${Math.round(kkalEnteral)} kkal/hari, ${targetProtein} g protein.\n`;
            teks += `Formula: ${densitasLabel}, volume total ${volTotal} mL/hari.\n`;
            if (volPerPemberian) {
                teks += `Pemberian: ${frekLabel} √ó ${volPerPemberian} mL/pemberian via NGT/sonde.\n`;
            } else {
                teks += `Pemberian: ${frekLabel} (${rateLabel}).\n`;
            }

            const ta = document.getElementById('terapiEnteral');
            if (ta) {
                ta.value = teks.trim();
                ta.style.height = 'auto';
                ta.style.height = ta.scrollHeight + 'px';
            }

            // Also fill summary in terapi medik gizi if empty
            const taMedik = document.getElementById('terapiMedikGizi');
            if (taMedik && !taMedik.value) {
                taMedik.value = `Target: ${targetKkal} kkal/hari, Protein ${targetProtein} g/hari, Lemak ${targetLemakG} g/hari (${pctLemak}%).`;
                taMedik.style.height = 'auto';
                taMedik.style.height = taMedik.scrollHeight + 'px';
            }
        }

        function calculatePSI() {
            let total = 0;
            let detailsTable = `<table class="scoring-table"><thead><tr><th>Parameter</th><th style="width:50px">Skor</th></tr></thead><tbody>`;

            const tgl = getValue('tglLahir');
            if(tgl) {
                const dob = new Date(tgl);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                if (today.getMonth() < dob.getMonth() || (today.getMonth() === dob.getMonth() && today.getDate() < dob.getDate())) age--;
                const jk = getValue('jk');
                let ageScore = (jk === 'P') ? Math.max(0, age - 10) : age;
                total += ageScore;
                detailsTable += `<tr><td>Usia (${age}) + Gender (${jk})</td><td>${ageScore}</td></tr>`;
            }

            document.querySelectorAll('.psi-check').forEach(c => {
                if(c.checked) {
                    const score = parseInt(c.dataset.score);
                    total += score;
                    detailsTable += `<tr><td>${c.parentElement.innerText.split(' (+')[0]}</td><td>${score}</td></tr>`;
                }
            });

            detailsTable += `<tr><td><strong>TOTAL</strong></td><td><strong>${total}</strong></td></tr></tbody></table>`;
            setText('totalScore', total);

            let kelas = "I", mort = "0.1%";
            if(total > 130) { kelas = "V"; mort = "29.2%"; }
            else if(total >= 91) { kelas = "IV"; mort = "8.2%"; }
            else if(total >= 71) { kelas = "III"; mort = "2.8%"; }
            else if(total > 0) { kelas = "II"; mort = "0.6%"; }

            setText('kelasRisiko', kelas);
            setText('mortalityRate', mort);
            document.getElementById('calc-psi-content').innerHTML = detailsTable;
        }

        function calculateNatrium() {
            const bb = parseFloat(getValue('bb'));
            const naSerum = parseFloat(getValue('naSerum'));
            const naTarget = parseFloat(getValue('naTarget'));
            const naInfus = parseFloat(getValue('naInfus'));
            const kecMax = parseFloat(getValue('naKecepatan'));
            const age = parseInt(document.getElementById('displayUmur')?.innerText) || 30;
            const jk = getValue('jk');

            setText('displayNaAwal', naSerum || 0);
            setText('displayNaTarget', naTarget || 0);
            const deltaTotal = naTarget - naSerum;
            setText('displayDeltaTotal', !isNaN(deltaTotal) ? deltaTotal.toFixed(1) : 0);

            const container = document.getElementById('natrium-tables-container');
            if (!bb || isNaN(naSerum) || isNaN(naTarget) || !container) return;

            container.innerHTML = "";
            if (deltaTotal <= 0) { container.innerHTML = "<tr><td colspan='2'>Target tercapai / Nilai serum lebih tinggi.</td></tr>"; return; }

            let tglAsesmen = getValue('tglAsesmen') ? new Date(getValue('tglAsesmen')) : new Date();
            let factor = (age <= 18) ? 0.6 : (jk === 'L' ? (age > 65 ? 0.5 : 0.6) : (age > 65 ? 0.45 : 0.5));
            const tbw = bb * factor;
            const deltaPerLiter = (naInfus - naSerum) / (tbw + 1);

            let sisaDelta = deltaTotal;
            let hari = 1;
            while (sisaDelta > 0.01) {
                let deltaHariIni = Math.min(sisaDelta, kecMax);
                const volmL = (deltaHariIni / deltaPerLiter) * 1000;
                const botol = Math.ceil(volmL / 500);
                const speed = (volmL / 24).toFixed(1);

                let d = new Date(tglAsesmen); d.setDate(tglAsesmen.getDate() + (hari - 1));
                const months = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
                const dateStr = `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;

                container.innerHTML += `
                <table class="scoring-table">
                    <thead><tr><th style="background:${hari === 1 ? '#4CAF50' : '#2196F3'}; color:white;">Rencana Hari ke-${hari} (${dateStr})</th><th>Hasil</th></tr></thead>
                    <tbody>
                        ${hari === 1 ? `<tr><td>TBW</td><td>${tbw.toFixed(1)} L</td></tr>` : ''}
                        <tr><td>Target &Delta; Na+</td><td>${deltaHariIni.toFixed(1)} mEq/L</td></tr>
                        <tr class="highlight-natrium"><td>Kebutuhan</td><td>${botol} Botol (Total ${volmL.toFixed(0)} mL)</td></tr>
                        <tr class="highlight-natrium"><td>Kecepatan</td><td>${speed} mL/jam</td></tr>
                    </tbody>
                </table>`;
                sisaDelta -= deltaHariIni;
                hari++;
                if(hari > 7) break;
            }
        }

        function calculateKalium() {
            const bb = parseFloat(getValue('bb'));
            const kSerum = parseFloat(getValue('kSerum'));
            const kTarget = parseFloat(getValue('kTarget')) || 3.5;
            const akses = getValue('aksesVena');
            const rateEq = parseFloat(getValue('kecepatanK')) || 5;

            setText('displayKaliumSerum', kSerum || 0);
            setText('displayKTarget', kTarget);
            const deltaK = kTarget - kSerum;
            setText('displayDeltaK', !isNaN(deltaK) && deltaK > 0 ? deltaK.toFixed(1) : "0");

            const kebutuhan = (bb * (kTarget - kSerum)) / 3;
            setText('displayKebutuhanK', !isNaN(kebutuhan) && kebutuhan > 0 ? kebutuhan.toFixed(1) : "0");

            const container = document.getElementById('kalium-instructions');
            if (!bb || isNaN(kSerum) || !container) return;

            if (kSerum >= kTarget) {
                container.innerHTML = `<tr><td colspan="2" style="text-align:center; color:green; font-weight:bold;">Kadar Kalium Normal / Target Tercapai.</td></tr>`;
                return;
            }

            const VIAL_MEQ = 25; // sediaan KCl 25 mEq/vial
            const nVials = Math.ceil(kebutuhan / VIAL_MEQ);
            const durasi = Math.round(kebutuhan / rateEq * 10) / 10;

            let rows = `
                <tr><td>Kalium Serum</td><td>${kSerum.toFixed(1)} mEq/L</td></tr>
                <tr><td>Target Koreksi</td><td>${kTarget.toFixed(1)} mEq/L</td></tr>
                <tr><td>Total Kebutuhan KCl</td><td><strong>${kebutuhan.toFixed(1)} mEq</strong></td></tr>
                <tr class="highlight-natrium"><td>Jumlah Vial KCl 25 mEq</td><td><strong>${nVials} vial</strong> (= ${nVials * VIAL_MEQ} mEq tersedia)</td></tr>
                <tr><td>Kecepatan Dipilih</td><td><strong>${rateEq} mEq/jam</strong></td></tr>
                <tr class="highlight-natrium"><td>Estimasi Durasi Total</td><td><strong>~${durasi} jam</strong></td></tr>
            `;

            // Safety warnings
            const jamPerBagCalc = VIAL_MEQ / rateEq; // durasi 1 botol/vial habis (jam)
            const warnings = [];
            if (akses === 'perifer' && kSerum < 3.0) {
                warnings.push('‚ö†Ô∏è K &lt;3.0 mEq/L ‚Äî Pertimbangkan akses vena sentral');
            }
            if (akses === 'perifer' && jamPerBagCalc < 4) {
                warnings.push(`‚ö†Ô∏è Kecepatan terlalu tinggi untuk perifer ‚Äî 1 botol habis dalam ~${Math.round(jamPerBagCalc * 10) / 10} jam (batas aman: 4‚Äì6 jam/botol). Kurangi kecepatan atau gunakan vena sentral.`);
            }
            if (rateEq > 20) {
                warnings.push('‚ö†Ô∏è Life-threatening: Monitoring ECG kontinu wajib. Pantau K setiap 1 jam. Tidak ada infus lain di kateter yang sama.');
            }
            if (warnings.length) {
                rows += warnings.map(w =>
                    `<tr><td colspan="2" style="background:#fff3e0; color:#e65100; font-weight:bold; padding:7px 10px;">${w}</td></tr>`
                ).join('');
            }

            if (akses === 'sentral') {
                // Central: 1 vial KCl 25 mEq in 100 mL NS = 250 mEq/L, via syringe pump
                const concSentral = 250; // mEq/L
                const mlPerH = Math.round(rateEq * 1000 / concSentral * 10) / 10; // rateEq √ó 4
                const jamPerVial = Math.round(VIAL_MEQ / rateEq * 10) / 10;
                rows += `
                    <tr style="background:#e3f2fd;"><td colspan="2" style="font-weight:bold; text-align:center;">VENA SENTRAL ‚Äî Syringe Pump</td></tr>
                    <tr><td>Persiapan per Syringe</td><td><strong>1 vial KCl 25 mEq</strong> dalam 100 mL NaCl 0.9%<br><small style="color:#666">(konsentrasi 250 mEq/L)</small></td></tr>
                    <tr class="highlight-natrium"><td>Kecepatan Pompa</td><td><strong>${mlPerH} mL/jam</strong> (= ${rateEq} mEq/jam)</td></tr>
                    <tr><td>Durasi per Syringe</td><td>~${jamPerVial} jam ‚Üí isi ulang total <strong>${nVials}√ó</strong></td></tr>
                    <tr><td>Rute</td><td>Vena sentral (diutamakan vena femoralis)</td></tr>
                    ${rateEq > 20
                        ? `<tr style="background:#ffebee;"><td colspan="2" style="color:#b71c1c; font-weight:bold;">Hentikan bila K ‚â•3.5 mEq/L atau timbul aritmia baru. Tidak boleh ada infus lain di kateter yang sama.</td></tr>`
                        : `<tr><td>Monitoring</td><td>Pantau K setiap 2‚Äì4 jam</td></tr>`}
                `;
            } else {
                // Peripheral: 1 vial KCl 25 mEq in 500 mL NS = 50 mEq/L (< 60 mEq/L limit)
                // Protocol: 20-40 mEq/L given over 4-6h ‚Üí practical rate 5-10 mEq/jam
                const concPerif = 50; // mEq/L (25 mEq / 500 mL)
                const mlPerH = Math.round(rateEq * 1000 / concPerif * 10) / 10; // rateEq √ó 20
                const jamPerBag = Math.round(VIAL_MEQ / rateEq * 10) / 10;
                rows += `
                    <tr style="background:#e8f5e9;"><td colspan="2" style="font-weight:bold; text-align:center;">VENA PERIFER (Vena Perifer Besar)</td></tr>
                    <tr><td>Persiapan per Botol</td><td><strong>1 vial KCl 25 mEq</strong> dalam <strong>500 mL NaCl 0.9%</strong><br><small style="color:#666">(konsentrasi 50 mEq/L ‚Äî di bawah batas aman 60 mEq/L)</small></td></tr>
                    <tr class="highlight-natrium"><td>Kecepatan Infus</td><td><strong>${mlPerH} mL/jam</strong> (= ${rateEq} mEq/jam)</td></tr>
                    <tr><td>Durasi per Botol</td><td>~${jamPerBag} jam ‚Üí ganti botol (total <strong>${nVials} botol</strong>)</td></tr>
                    <tr><td>Monitoring</td><td>Pantau K setiap 4‚Äì6 jam. Gunakan NaCl, bukan Dextrose.</td></tr>
                    <tr style="background:#fff8e1;"><td>Peringatan</td><td>Jangan melebihi <strong>60 mEq/L</strong> pada perifer (risiko nyeri &amp; sklerosis vena)</td></tr>
                `;
            }
            container.innerHTML = rows;
        }

        // ‚îÄ‚îÄ‚îÄ MODAL SKRINING GIZI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const TABEL7_DATA = {
            akut: {
                label: 'Penyakit Akut / Cedera',
                sedang: [
                    ['Asupan Energi', '<75% kebutuhan selama >7 hari'],
                    ['Penurunan BB', '1‚Äì2%/1 minggu; 5%/1 bulan; 7.5%/3 bulan'],
                    ['Kehilangan Lemak', 'Ringan (mild)'],
                    ['Kehilangan Otot', 'Ringan (mild)'],
                    ['Akumulasi Cairan', 'Edema ringan (mild)'],
                ],
                berat: [
                    ['Asupan Energi', '‚â§50% kebutuhan selama ‚â•5 hari'],
                    ['Penurunan BB', '>2%/1 minggu; >5%/1 bulan; >7.5%/3 bulan'],
                    ['Kehilangan Lemak', 'Sedang (moderate)'],
                    ['Kehilangan Otot', 'Sedang (moderate)'],
                    ['Akumulasi Cairan', 'Edema sedang‚Äìberat'],
                ]
            },
            kronik: {
                label: 'Penyakit Kronik',
                sedang: [
                    ['Asupan Energi', '<75% kebutuhan selama ‚â•1 bulan'],
                    ['Penurunan BB', '5%/1 bulan; 7.5%/3 bulan; 10%/6 bulan; 20%/1 tahun'],
                    ['Kehilangan Lemak', 'Ringan (mild)'],
                    ['Kehilangan Otot', 'Ringan (mild)'],
                    ['Akumulasi Cairan', 'Edema ringan'],
                ],
                berat: [
                    ['Asupan Energi', '‚â§75% kebutuhan selama ‚â•1 bulan'],
                    ['Penurunan BB', '>5%/1 bulan; >7.5%/3 bulan; >10%/6 bulan; >20%/1 tahun'],
                    ['Kehilangan Lemak', 'Sedang (moderate)'],
                    ['Kehilangan Otot', 'Berat (severe)'],
                    ['Akumulasi Cairan', 'Edema berat'],
                ]
            },
            sosial: {
                label: 'Sosial / Lingkungan',
                sedang: [
                    ['Asupan Energi', '<75% kebutuhan selama ‚â•3 bulan'],
                    ['Penurunan BB', '5%/1 bulan; 7.5%/3 bulan; 10%/6 bulan; 20%/1 tahun'],
                    ['Kehilangan Lemak', 'Ringan (mild)'],
                    ['Kehilangan Otot', 'Ringan (mild)'],
                    ['Akumulasi Cairan', 'Edema ringan'],
                ],
                berat: [
                    ['Asupan Energi', '‚â§50% kebutuhan selama >7 hari'],
                    ['Penurunan BB', '>5%/1 bulan; >7.5%/3 bulan; >10%/6 bulan; >20%/1 tahun'],
                    ['Kehilangan Lemak', 'Berat (severe)'],
                    ['Kehilangan Otot', 'Berat (severe)'],
                    ['Akumulasi Cairan', 'Edema berat / anasarka'],
                ]
            }
        };

        let currentEtiologi = 'akut';
        let activeModalTab = 'aspen';

        function openSkriningModal() {
            const bb = parseFloat(getValue('bb'));
            const tb = parseFloat(getValue('tb'));
            document.getElementById('modal-bb').textContent = bb || '-';
            document.getElementById('modal-tb').textContent = tb || '-';
            if (bb && tb) {
                const bmi = bb / Math.pow(tb / 100, 2);
                document.getElementById('modal-bmi').textContent = bmi.toFixed(1);
                highlightBMIRow(bmi);
            } else {
                document.getElementById('modal-bmi').textContent = '-';
                document.querySelectorAll('[id^="bmi-row-"]').forEach(r => r.classList.remove('match'));
            }
            renderTabel7(currentEtiologi);
            calcAspen();
            document.getElementById('modal-skrining').style.display = 'block';
        }

        function closeSkriningModal() {
            document.getElementById('modal-skrining').style.display = 'none';
        }

        function showModalTab(tab) {
            activeModalTab = tab;
            ['aspen','tabel7','antropo','nrs'].forEach(t => {
                document.getElementById('modal-body-' + t).style.display = (t === tab) ? 'block' : 'none';
                document.getElementById('mtab-' + t).classList.toggle('active', t === tab);
            });
            if (tab === 'antropo') {
                const bb = parseFloat(getValue('bb'));
                const tb = parseFloat(getValue('tb'));
                document.getElementById('modal-bb').textContent = bb || '-';
                document.getElementById('modal-tb').textContent = tb || '-';
                if (bb && tb) {
                    const bmi = bb / Math.pow(tb / 100, 2);
                    document.getElementById('modal-bmi').textContent = bmi.toFixed(1);
                    highlightBMIRow(bmi);
                }
            }
            if (tab === 'nrs') calcNRS();
        }

        function highlightBMIRow(bmi) {
            const ranges = [
                [1, bmi < 17],
                [2, bmi >= 17 && bmi < 18.5],
                [3, bmi >= 18.5 && bmi < 25],
                [4, bmi >= 25 && bmi < 30],
                [5, bmi >= 30 && bmi < 35],
                [6, bmi >= 35],
            ];
            ranges.forEach(([n, match]) => {
                const row = document.getElementById('bmi-row-' + n);
                if (row) row.classList.toggle('match', match);
            });
        }

        function calcLLA() {
            const lla = parseFloat(document.getElementById('modal-lla')?.value);
            const jk = getValue('jk');
            const resultEl = document.getElementById('lla-result');
            document.querySelectorAll('[id^="lla-row-"]').forEach(r => r.classList.remove('match'));
            if (!lla || !resultEl) return;
            let klasif = '', rowId = '';
            if (jk === 'L') {
                if (lla < 19.5) { klasif = 'Malnutrisi Berat'; rowId = 'lla-row-1'; }
                else if (lla < 21.5) { klasif = 'Malnutrisi Sedang'; rowId = 'lla-row-2'; }
                else { klasif = 'Normal'; rowId = 'lla-row-3'; }
            } else {
                if (lla < 18.5) { klasif = 'Malnutrisi Berat'; rowId = 'lla-row-1'; }
                else if (lla < 20.5) { klasif = 'Malnutrisi Sedang'; rowId = 'lla-row-2'; }
                else { klasif = 'Normal'; rowId = 'lla-row-3'; }
            }
            if (rowId) document.getElementById(rowId)?.classList.add('match');
            resultEl.textContent = 'Klasifikasi LLA: ' + klasif;
        }

        function calcAspen() {
            const names = ['aspen1','aspen2','aspen3','aspen4','aspen5','aspen6'];
            let sedang = 0, berat = 0;
            names.forEach(name => {
                const val = document.querySelector('input[name="' + name + '"]:checked')?.value || '0';
                if (val === 'sedang') sedang++;
                if (val === 'berat') berat++;
            });
            const total = sedang + berat;
            document.getElementById('aspen-badge-sedang').textContent = sedang + ' Sedang';
            document.getElementById('aspen-badge-berat').textContent = berat + ' Berat';
            const noteEl = document.getElementById('aspen-diagnosis-note');
            if (total >= 2) {
                noteEl.textContent = '‚úì Memenuhi syarat diagnosis malnutrisi (' + total + ' dari 6 kriteria).';
                noteEl.style.color = '#b71c1c';
            } else {
                noteEl.textContent = 'Belum memenuhi syarat diagnosis (butuh ‚â•2 kriteria).';
                noteEl.style.color = '#888';
            }
            updateModalResult();
        }

        function updateModalResult() {
            const names = ['aspen1','aspen2','aspen3','aspen4','aspen5','aspen6'];
            let sedang = 0, berat = 0;
            names.forEach(name => {
                const val = document.querySelector('input[name="' + name + '"]:checked')?.value || '0';
                if (val === 'sedang') sedang++;
                if (val === 'berat') berat++;
            });
            const total = sedang + berat;
            const pill = document.getElementById('modal-result-pill');
            pill.className = 'result-pill';
            if (total >= 2 && berat >= 2) {
                pill.textContent = 'MALNUTRISI BERAT';
                pill.classList.add('berat');
            } else if (total >= 2) {
                pill.textContent = 'MALNUTRISI SEDANG';
                pill.classList.add('sedang');
            } else {
                pill.textContent = 'Belum dinilai / Tidak Malnutrisi';
            }
        }

        function selectEtiologi(key) {
            currentEtiologi = key;
            document.querySelectorAll('.etiologi-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('etbtn-' + key)?.classList.add('selected');
            renderTabel7(key);
        }

        function renderTabel7(key) {
            const data = TABEL7_DATA[key];
            if (!data) return;
            const container = document.getElementById('tabel7-content');
            let html = `<div class="t7-row">
                <div class="t7-cell t7-header">Parameter</div>
                <div class="t7-cell t7-header t7-sedang" style="text-align:center;">üü° Sedang</div>
                <div class="t7-cell t7-header t7-berat" style="text-align:center;">üî¥ Berat</div>
            </div>`;
            for (let i = 0; i < data.sedang.length; i++) {
                html += `<div class="t7-row">
                    <div class="t7-cell t7-label">${data.sedang[i][0]}</div>
                    <div class="t7-cell t7-sedang">${data.sedang[i][1]}</div>
                    <div class="t7-cell t7-berat">${data.berat[i][1]}</div>
                </div>`;
            }
            container.innerHTML = html;
        }

        function calcNRS() {
            const pre1 = document.getElementById('nrs_pre1')?.checked;
            const pre2 = document.getElementById('nrs_pre2')?.checked;
            const pre3 = document.getElementById('nrs_pre3')?.checked;
            const pre4 = document.getElementById('nrs_pre4')?.checked;
            const anyPre = pre1 || pre2 || pre3 || pre4;
            const note = document.getElementById('nrs-prescreen-note');
            const finalSection = document.getElementById('nrs-final-section');
            const pill = document.getElementById('modal-result-pill');

            if (!anyPre) {
                if (note) { note.textContent = 'Semua jawaban TIDAK ‚Üí Skrining ulang setiap 1 minggu.'; note.style.borderLeftColor = '#A5D6A7'; note.style.background = '#e8f5e9'; }
                if (finalSection) finalSection.style.display = 'none';
                if (pill) { pill.className = 'result-pill'; pill.textContent = 'NRS: Pre-screen semua TIDAK'; }
                return;
            }
            if (note) { note.textContent = 'Ada jawaban YA ‚Üí Lanjutkan ke Langkah 2.'; note.style.borderLeftColor = '#FFB74D'; note.style.background = '#fff8e1'; }
            if (finalSection) finalSection.style.display = 'block';

            const sNutr = parseInt(document.querySelector('input[name="nrs_nutr"]:checked')?.value || '0');
            const sDis  = parseInt(document.querySelector('input[name="nrs_dis"]:checked')?.value  || '0');
            const ageText = document.getElementById('displayUmur')?.innerText || '';
            const age = parseInt(ageText) || 0;
            const sAge = age >= 70 ? 1 : 0;
            const total = sNutr + sDis + sAge;

            const ageInfo = document.getElementById('nrs-age-info');
            if (ageInfo) ageInfo.textContent = age > 0
                ? `Usia pasien: ${age} tahun ‚Üí Koreksi usia: +${sAge}`
                : 'Usia belum diisi pada form utama (isi Tgl Lahir)';

            document.getElementById('nrs-s-nutr').textContent = sNutr;
            document.getElementById('nrs-s-dis').textContent  = sDis;
            document.getElementById('nrs-s-age').textContent  = sAge;
            document.getElementById('nrs-s-total').textContent = total;

            const resultBox = document.getElementById('nrs-result-box');
            if (resultBox) {
                resultBox.style.display = 'block';
                if (total >= 3) {
                    resultBox.className = 'nrs-result-box risk';
                    resultBox.textContent = `Total ${total} ‚â• 3 ‚Üí Pasien BERISIKO MALNUTRISI ‚Äî buat rencana dukungan nutrisi`;
                } else {
                    resultBox.className = 'nrs-result-box no-risk';
                    resultBox.textContent = `Total ${total} < 3 ‚Üí Tidak berisiko saat ini ‚Äî skrining ulang 1 minggu`;
                }
            }
            if (pill) {
                pill.className = 'result-pill' + (total >= 3 ? ' sedang' : '');
                pill.textContent = total >= 3
                    ? `NRS-2002 Skor ${total} ‚Äî Berisiko Malnutrisi`
                    : `NRS-2002 Skor ${total} ‚Äî Tidak Berisiko`;
            }
        }

        function applySkriningResult() {
            if (activeModalTab === 'nrs') {
                // Apply NRS-2002 result
                const anyPre = ['nrs_pre1','nrs_pre2','nrs_pre3','nrs_pre4'].some(id => document.getElementById(id)?.checked);
                const sNutr = parseInt(document.querySelector('input[name="nrs_nutr"]:checked')?.value || '0');
                const sDis  = parseInt(document.querySelector('input[name="nrs_dis"]:checked')?.value  || '0');
                const age   = parseInt(document.getElementById('displayUmur')?.innerText) || 0;
                const sAge  = age >= 70 ? 1 : 0;
                const total = anyPre ? (sNutr + sDis + sAge) : 0;
                const dropdownVal = (total >= 3)
                    ? 'NRS-2002 skor \u22653 (Berisiko Malnutrisi)'
                    : 'NRS-2002 skor <3 (Tidak Berisiko)';
                const detail = `NRS-2002 Total: ${total} (Nutrisi ${sNutr} + Penyakit ${sDis} + Usia ${sAge}) ‚Üí ${total >= 3 ? 'Berisiko Malnutrisi' : 'Tidak Berisiko'}`;
                const sel = document.getElementById('hasilSkrining');
                if (sel) { for (let opt of sel.options) { if (opt.value === dropdownVal) { sel.value = dropdownVal; break; } } }
                const ta = document.getElementById('skriningDetail');
                if (ta) { ta.value = detail; ta.style.height = 'auto'; ta.style.height = ta.scrollHeight + 'px'; }
                updateStats();
                closeSkriningModal();
                return;
            }

            // Apply ASPEN result
            const names = ['aspen1','aspen2','aspen3','aspen4','aspen5','aspen6'];
            const kritNames = [
                'Asupan energi tidak adekuat',
                'Penurunan berat badan',
                'Penurunan massa otot',
                'Penurunan massa lemak subkutan',
                'Akumulasi cairan (edema)',
                'Penurunan status fungsional',
            ];
            let sedang = 0, berat = 0;
            const kriteriaTerpenuhi = [];
            names.forEach((name, i) => {
                const val = document.querySelector('input[name="' + name + '"]:checked')?.value || '0';
                if (val === 'sedang') { sedang++; kriteriaTerpenuhi.push(kritNames[i] + ' (Sedang)'); }
                if (val === 'berat')  { berat++;  kriteriaTerpenuhi.push(kritNames[i] + ' (Berat)');  }
            });
            const total = sedang + berat;
            if (total >= 2) {
                const isBerat = berat >= 2;
                const etiLabel = TABEL7_DATA[currentEtiologi]?.label || '';
                const detail = 'ASPEN: ' + kriteriaTerpenuhi.join('; ') + '. Etiologi: ' + etiLabel + '.';
                const ta = document.getElementById('skriningDetail');
                if (ta) {
                    ta.value = detail;
                    ta.style.height = 'auto';
                    ta.style.height = ta.scrollHeight + 'px';
                }
                const sel = document.getElementById('hasilSkrining');
                if (sel) {
                    const target = isBerat ? 'SGA C (Malnutrisi Berat)' : 'SGA B (Malnutrisi Ringan-Sedang)';
                    for (let opt of sel.options) {
                        if (opt.value === target) { sel.value = target; break; }
                    }
                }
                updateStats();
            }
            closeSkriningModal();
        }
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function changeKacepatanK(dir) {
            const sel = document.getElementById('kecepatanK');
            if (!sel) return;
            const newIdx = sel.selectedIndex + dir;
            if (newIdx >= 0 && newIdx < sel.options.length) {
                sel.selectedIndex = newIdx;
                updateStats();
            }
        }

        function getValue(id) { return document.getElementById(id)?.value; }
        function setText(id, txt) { const el = document.getElementById(id); if (el) el.innerText = txt; }
        function printAndDownload() { window.print(); }
    </script>
</body>
</html>
